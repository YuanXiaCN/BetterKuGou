<template>
  <div class="favorite-view">
    <div class="page-header">
      <h1 class="page-title">我喜欢的音乐</h1>
      <div class="header-actions">
        <button class="action-btn" @click="playAll">
          <svg viewBox="0 0 1024 1024" width="18" height="18" fill="currentColor">
            <path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"/>
            <path d="M719.4 499.1l-296.1-215A15.9 15.9 0 00398 297v430c0 13.1 14.8 20.5 25.3 12.9l296.1-215a15.9 15.9 0 000-25.8zm-257.6 134V390.9L628.5 512 461.8 633.1z"/>
          </svg>
          播放全部
        </button>
      </div>
    </div>

    <!-- 加载状态 -->
    <div v-if="loading" class="loading-container">
      <img src="../icon/loding.gif" alt="加载中" class="loading-gif" />
      <p>加载中...</p>
    </div>

    <!-- 空状态 -->
    <div v-else-if="favoriteList.length === 0" class="empty-state">
      <svg viewBox="0 0 1024 1024" width="80" height="80" fill="currentColor" opacity="0.3">
        <path d="M923 283.6a260.04 260.04 0 00-56.9-82.8 264.4 264.4 0 00-84-55.5A265.34 265.34 0 00679.7 125c-49.3 0-97.4 13.5-139.2 39-10 6.1-19.5 12.8-28.5 20.1-9-7.3-18.5-14-28.5-20.1-41.8-25.5-89.9-39-139.2-39-35.5 0-69.9 6.8-102.4 20.3-31.4 13-59.7 31.7-84 55.5a258.44 258.44 0 00-56.9 82.8c-13.9 32.3-21 66.6-21 101.9 0 33.3 6.8 68 20.3 103.3 11.3 29.5 27.5 60.1 48.2 91 32.8 48.9 77.9 99.9 133.9 151.6 92.8 85.7 184.7 144.9 188.6 147.3l23.7 15.2c10.5 6.7 24 6.7 34.5 0l23.7-15.2c3.9-2.5 95.7-61.6 188.6-147.3 56-51.7 101.1-102.7 133.9-151.6 20.7-30.9 37-61.5 48.2-91 13.5-35.3 20.3-70 20.3-103.3.1-35.3-7-69.6-20.9-101.9z"/>
      </svg>
      <p class="empty-text">还没有收藏的歌曲</p>
      <p class="empty-hint">去发现页面找些喜欢的音乐吧</p>
      <button class="primary-btn" @click="goToDiscover">
        去发现音乐
      </button>
    </div>

    <!-- 歌曲列表 -->
    <div v-else class="song-list">
      <div class="list-header">
        <div class="col-index" @click="toggleSortOrder">
          <span>#</span>
          <span class="sort-arrow" v-if="sortOrder === 'asc'">↑</span>
          <span class="sort-arrow" v-else-if="sortOrder === 'desc'">↓</span>
          <span class="sort-arrow" v-else>↕</span>
        </div>
        <div class="col-title">歌曲</div>
        <div class="col-artist">歌手</div>
        <div class="col-album">专辑</div>
        <div class="col-duration">时长</div>
      </div>

      <div 
        v-for="(song, index) in sortedFavoriteList" 
        :key="song.hash"
        class="song-item"
        :class="{ playing: isCurrentlyPlaying(song) }"
        @dblclick="playSong(song)"
        @contextmenu.prevent.stop="showContextMenu($event, song)"
      >
        <div class="col-index">
          <span class="index-number">{{ index + 1 }}</span>
        </div>

        <div class="col-title">
          <img v-if="song.cover" :src="song.cover.replace('{size}', '400')" class="song-cover" :alt="song.name" />
          <div class="song-info">
            <div class="song-name">
              {{ getSongName(song.name) }}
              <span v-if="song.relate_goods && song.relate_goods.some(g => g.level >= 5)" class="quality-badge">SQ</span>
            </div>
          </div>
        </div>

        <div class="col-artist">
          <span class="artist-link" @click.stop="goArtist(song)">
            {{ getSingerNames(song.singerinfo, song) || song.singername || song.author_name || (song.name && song.name.includes(' - ') ? song.name.split(' - ')[0] : '-') }}
          </span>
        </div>
  <div class="col-album"><span class="album-link" @click.stop="goAlbum(song)">{{ song.albuminfo?.name || song.remark || '-' }}</span></div>
        <div class="col-duration">
          {{ formatDuration(song.timelen) }}
          <div class="action-buttons">
            <button class="icon-btn play-btn-inline" @click.stop="playSong(song)" :title="isCurrentlyPlaying(song) ? '暂停' : '播放'">
              <svg v-if="isCurrentlyPlaying(song)" viewBox="0 0 1024 1024" width="16" height="16" fill="currentColor">
                <path d="M304 176h80v672h-80zm336 0h80v672h-80z"/>
              </svg>
              <svg v-else viewBox="0 0 1024 1024" width="16" height="16" fill="currentColor">
                <path d="M719.4 499.1l-296.1-215A15.9 15.9 0 00398 297v430c0 13.1 14.8 20.5 25.3 12.9l296.1-215a15.9 15.9 0 000-25.8z"/>
              </svg>
            </button>
            <button class="icon-btn favorite-btn active" @click.stop="removeFavorite(song)" title="取消收藏">
              <svg viewBox="0 0 1024 1024" width="16" height="16" fill="currentColor">
                <path d="M923 283.6a260.04 260.04 0 00-56.9-82.8 264.4 264.4 0 00-84-55.5A265.34 265.34 0 00679.7 125c-49.3 0-97.4 13.5-139.2 39-10 6.1-19.5 12.8-28.5 20.1-9-7.3-18.5-14-28.5-20.1-41.8-25.5-89.9-39-139.2-39-35.5 0-69.9 6.8-102.4 20.3-31.4 13-59.7 31.7-84 55.5a258.44 258.44 0 00-56.9 82.8c-13.9 32.3-21 66.6-21 101.9 0 33.3 6.8 68 20.3 103.3 11.3 29.5 27.5 60.1 48.2 91 32.8 48.9 77.9 99.9 133.9 151.6 92.8 85.7 184.7 144.9 188.6 147.3l23.7 15.2c10.5 6.7 24 6.7 34.5 0l23.7-15.2c3.9-2.5 95.7-61.6 188.6-147.3 56-51.7 101.1-102.7 133.9-151.6 20.7-30.9 37-61.5 48.2-91 13.5-35.3 20.3-70 20.3-103.3.1-35.3-7-69.6-20.9-101.9z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 右键菜单 -->
    <ContextMenu
      :visible="contextMenuVisible"
      :position="contextMenuPosition"
      :items="contextMenuItems"
      @close="contextMenuVisible = false"
    />
  </div>
</template>

<script>
import { getUserPlaylists, getPlaylistTracks } from '../api/music.js'
import ContextMenu from './ContextMenu.vue'
import contextMenuManager from '../utils/contextMenuManager.js'
import { useSettingsStore } from '../stores/settingsStore.js'

export default {
  name: 'FavoriteView',
  components: {
    ContextMenu
  },
  props: {
    currentSong: {
      type: Object,
      default: null
    }
  },
  setup() {
    const { settings } = useSettingsStore()
    return { settings }
  },
  data() {
    return {
      loading: false,
      favoriteList: [],
      favoritePlaylistId: null, // 收藏歌单的 ID
      contextMenuVisible: false,
      contextMenuPosition: { x: 0, y: 0 },
      currentContextSong: null,
      sortOrder: 'none', // 排序状态: 'none', 'asc', 'desc'
      isPlayingSong: false // 防止重复播放请求
    }
  },
  computed: {
    // 安全地获取当前播放歌曲的 hash
    currentPlayingHash() {
      const hash = this.currentSong?.hash || null
      console.log('🎵 [FavoriteView] currentPlayingHash 计算:', {
        currentSong: this.currentSong,
        hash: hash,
        name: this.currentSong?.name || this.currentSong?.filename,
        timestamp: new Date().toLocaleTimeString()
      })
      return hash
    },
    // 计算排序后的歌曲列表
    sortedFavoriteList() {
      if (this.sortOrder === 'none') {
        return this.favoriteList
      }
      
      // 创建副本以避免修改原始数组
      const sortedList = [...this.favoriteList]
      
      if (this.sortOrder === 'asc') {
        // 升序排列
        return sortedList.sort((a, b) => a.index - b.index)
      } else {
        // 降序排列
        return sortedList.sort((a, b) => b.index - a.index)
      }
    },
    contextMenuItems() {
      if (!this.currentContextSong) return []
      
      const isFavorite = this.favoriteList.some(s => s.hash === this.currentContextSong.hash)
      
      return [
        {
          label: '播放',
          icon: 'M719.4 499.1l-296.1-215A15.9 15.9 0 00398 297v430c0 13.1 14.8 20.5 25.3 12.9l296.1-215a15.9 15.9 0 000-25.8z',
          action: () => this.playSong(this.currentContextSong)
        },
        {
          label: '下一首播放',
          icon: 'M272.9 512l265.4-339.1c4.1-5.2.4-12.9-6.3-12.9h-77.3c-4.9 0-9.6 2.3-12.6 6.1L186.8 492.3a31.99 31.99 0 000 39.5l255.3 326.1c3 3.9 7.7 6.1 12.6 6.1H532c6.7 0 10.4-7.7 6.3-12.9L272.9 512zm304 0l265.4-339.1c4.1-5.2.4-12.9-6.3-12.9h-77.3c-4.9 0-9.6 2.3-12.6 6.1L490.8 492.3a31.99 31.99 0 000 39.5l255.3 326.1c3 3.9 7.7 6.1 12.6 6.1H836c6.7 0 10.4-7.7 6.3-12.9L576.9 512z',
          action: () => this.playNext(this.currentContextSong)
        },
        { divider: true },
        {
          label: isFavorite ? '取消收藏' : '收藏',
          icon: 'M923 283.6a260.04 260.04 0 00-56.9-82.8 264.4 264.4 0 00-84-55.5A265.34 265.34 0 00679.7 125c-49.3 0-97.4 13.5-139.2 39-10 6.1-19.5 12.8-28.5 20.1-9-7.3-18.5-14-28.5-20.1-41.8-25.5-89.9-39-139.2-39-35.5 0-69.9 6.8-102.4 20.3-31.4 13-59.7 31.7-84 55.5a258.44 258.44 0 00-56.9 82.8c-13.9 32.3-21 66.6-21 101.9 0 33.3 6.8 68 20.3 103.3 11.3 29.5 27.5 60.1 48.2 91 32.8 48.9 77.9 99.9 133.9 151.6 92.8 85.7 184.7 144.9 188.6 147.3l23.7 15.2c10.5 6.7 24 6.7 34.5 0l23.7-15.2c3.9-2.5 95.7-61.6 188.6-147.3 56-51.7 101.1-102.7 133.9-151.6 20.7-30.9 37-61.5 48.2-91 13.5-35.3 20.3-70 20.3-103.3.1-35.3-7-69.6-20.9-101.9z',
          action: () => this.toggleFavorite(this.currentContextSong)
        },
        {
          label: '下载',
          icon: 'M505.7 661a8 8 0 0012.6 0l112-141.7c4.1-5.2.4-12.9-6.3-12.9h-74.1V168c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8v338.3H400c-6.7 0-10.4 7.7-6.3 12.9l112 141.8zM878 626h-60c-4.4 0-8 3.6-8 8v154H214V634c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8v198c0 17.7 14.3 32 32 32h684c17.7 0 32-14.3 32-32V634c0-4.4-3.6-8-8-8z',
          action: () => this.downloadSong(this.currentContextSong)
        },
        {
          label: '分享',
          icon: 'M752 664c-28.5 0-54.8 10-75.4 26.7L469.4 540.8a160.68 160.68 0 000-57.6l207.2-149.9C697.2 350 723.5 360 752 360c66.2 0 120-53.8 120-120s-53.8-120-120-120-120 53.8-120 120c0 11.6 1.6 22.7 4.7 33.3L439.9 415.8C410.7 377.1 364.3 352 312 352c-88.4 0-160 71.6-160 160s71.6 160 160 160c52.3 0 98.7-25.1 127.9-63.8l196.8 142.5c-3.1 10.6-4.7 21.8-4.7 33.3 0 66.2 53.8 120 120 120s120-53.8 120-120-53.8-120-120-120zm0-476c28.7 0 52 23.3 52 52s-23.3 52-52 52-52-23.3-52-52 23.3-52 52-52zM312 600c-48.5 0-88-39.5-88-88s39.5-88 88-88 88 39.5 88 88-39.5 88-88 88zm440 236c-28.7 0-52-23.3-52-52s23.3-52 52-52 52 23.3 52 52-23.3 52-52 52z',
          action: () => this.shareSong(this.currentContextSong)
        },
        { divider: true },
        {
          label: '从播放列表中移除',
          icon: 'M360 184h-8c4.4 0 8-3.6 8-8v8h304v-8c0 4.4 3.6 8 8 8h-8v72h72v-80c0-35.3-28.7-64-64-64H352c-35.3 0-64 28.7-64 64v80h72v-72zm504 72H160c-17.7 0-32 14.3-32 32v32c0 4.4 3.6 8 8 8h60.4l24.7 523c1.6 34.1 29.8 61 63.9 61h454c34.2 0 62.3-26.8 63.9-61l24.7-523H888c4.4 0 8-3.6 8-8v-32c0-17.7-14.3-32-32-32zM731.3 840H292.7l-24.2-512h487l-24.2 512z',
          action: () => this.removeFromPlaylist(this.currentContextSong)
        },
        {
          label: '搜索',
          icon: 'M909.6 854.5L649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0011.6 0l43.6-43.5a8.2 8.2 0 000-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z',
          action: () => this.searchSong(this.currentContextSong)
        }
      ]
    }
  },
  watch: {
    currentSong: {
      handler(newSong, oldSong) {
        // 监听当前播放歌曲的变化，用于调试
        console.log('🎵 [FavoriteView] currentSong changed', {
          old: oldSong ? oldSong.hash : null,
          new: newSong ? newSong.hash : null,
          oldName: oldSong ? oldSong.name : null,
          newName: newSong ? newSong.name : null
        });
        
        // 强制重新渲染组件，确保UI状态与数据状态保持一致
        this.$forceUpdate()
      },
      deep: true
    }
  },
  mounted() {
    this.loadFavorites()
    
    console.log('🔧 [FavoriteView] 组件已挂载，isCurrentlyPlaying 方法可用:', typeof this.isCurrentlyPlaying)
    
    // 调试：监听 currentSong 变化
    this.$watch('currentSong', (newVal, oldVal) => {
      console.log('🎵 [FavoriteView] currentSong 变化:', {
        old: oldVal?.hash,
        new: newVal?.hash,
        oldName: oldVal?.name,
        newName: newVal?.name
      })
    }, { deep: true })
    
    // 调试：监听 currentPlayingHash 变化
    this.$watch('currentPlayingHash', (newVal, oldVal) => {
      console.log('🎵 [FavoriteView] currentPlayingHash 变化:', {
        old: oldVal,
        new: newVal
      })
      // 强制触发一次重新渲染检查
      this.$nextTick(() => {
        if (process.env.NODE_ENV === 'development') {
          console.log('🔄 [FavoriteView] 下一个tick，强制检查高亮状态')
        }
        // 检查当前播放歌曲是否在收藏列表中
        if (this.favoriteList.length > 0) {
          this.checkCurrentSongInFavorites()
        }
      })
    })
  },
  methods: {
    // 检查是否为当前播放歌曲（优化版本）
    isCurrentlyPlaying(song) {
      if (!song || !song.hash) return false
      
      // 优化：直接检查hash匹配，避免重复计算和大量日志
      const hashMatch = this.currentPlayingHash === song.hash
      const songMatch = this.currentSong?.hash === song.hash
      const result = hashMatch || songMatch
      
      // 只在开发环境且找到匹配时输出日志
      if (process.env.NODE_ENV === 'development' && result) {
        console.log('🎯 [FavoriteView] 找到匹配的歌曲!', song.name)
      }
      
      return result
    },
    
    // 调试方法：检查当前播放歌曲是否在收藏列表中
    checkCurrentSongInFavorites() {
      if (!this.currentSong || !this.currentPlayingHash) {
        console.log('🔍 [FavoriteView] 当前没有播放歌曲')
        return
      }
      
      if (process.env.NODE_ENV === 'development') {
        console.log('🔍 [FavoriteView] 检查当前播放歌曲是否在收藏列表中:')
        console.log('  - 当前播放:', this.currentSong.name)
        console.log('  - Hash:', this.currentPlayingHash)
        console.log('  - 收藏列表总数:', this.favoriteList.length)
      }
      
      // 按Hash查找（优化：使用缓存和更高效的查找）
      const foundByHash = this.favoriteList.find(song => song.hash === this.currentPlayingHash)
      if (foundByHash) {
        if (process.env.NODE_ENV === 'development') {
          console.log('  - ✅ 通过Hash找到:', foundByHash.name)
        }
        return foundByHash
      }
      
      // 按歌曲名查找（模糊匹配）- 简化逻辑
      const currentName = this.currentSong.name?.toLowerCase()
      if (currentName) {
        const foundByName = this.favoriteList.find(song => {
          return song.name && song.name.toLowerCase().includes(currentName.split(' - ').pop())
        })
        
        if (foundByName) {
          if (process.env.NODE_ENV === 'development') {
            console.log('  - 🔍 通过歌名找到可能匹配:', foundByName.name, 'Hash:', foundByName.hash)
          }
          return foundByName
        }
      }
      
      if (process.env.NODE_ENV === 'development') {
        console.log('  - ❌ 在收藏列表中没有找到当前播放的歌曲')
      }
      
      return null
    },
    
    // 加载收藏列表
    async loadFavorites() {
      this.loading = true
      try {
        // 检查登录状态
        const token = localStorage.getItem('kugou_token')
        const userid = localStorage.getItem('kugou_userid')
        console.log('Token:', token ? '存在' : '不存在')
        console.log('UserID:', userid)
        
        if (!token || !userid) {
          console.warn('未登录或缺少认证信息')
          this.loading = false
          return
        }
        
        // 1. 获取用户歌单列表
        const playlistRes = await getUserPlaylists(1, 100)
        console.log('用户歌单:', playlistRes)
        
        if (playlistRes.status === 1 && playlistRes.data) {
          const playlists = playlistRes.data.info || []
          
          // 2. 找到"我喜欢的音乐"歌单（通常是第一个，或者名称包含"喜欢"）
          const favoritePlaylist = playlists.find(p => 
            p.name === '我喜欢的音乐' || 
            p.name.includes('喜欢') || 
            p.list_id === '3' // 酷狗默认的收藏歌单 ID
          ) || playlists[0] // 如果找不到就用第一个
          
          if (favoritePlaylist) {
            this.favoritePlaylistId = favoritePlaylist.global_collection_id
            console.log('收藏歌单 ID:', this.favoritePlaylistId)
            
            // 3. 分页获取该歌单的所有歌曲
            let allSongs = []
            let page = 1
            const pageSize = 300 // 每页最多300首
            let totalCount = 0
            
            // 第一次请求获取总数
            const firstRes = await getPlaylistTracks(this.favoritePlaylistId, page, pageSize)
            console.log('第一页收藏歌曲:', firstRes)
            
            if (firstRes.status === 1 && firstRes.data) {
              totalCount = firstRes.data.count || 0
              allSongs = firstRes.data.songs || []
              console.log(`总共 ${totalCount} 首歌曲，已加载 ${allSongs.length} 首`)
              
              // 如果还有更多歌曲，继续分页获取
              const totalPages = Math.ceil(totalCount / pageSize)
              for (let i = 2; i <= totalPages; i++) {
                const pageRes = await getPlaylistTracks(this.favoritePlaylistId, i, pageSize)
                if (pageRes.status === 1 && pageRes.data && pageRes.data.songs) {
                  allSongs = allSongs.concat(pageRes.data.songs)
                  console.log(`已加载第 ${i} 页，当前共 ${allSongs.length} 首`)
                }
              }
              
              // 为每首歌曲添加index属性
              this.favoriteList = allSongs.map((song, index) => ({
                ...song,
                index: index + 1
              }))
              console.log(`最终加载完成：${this.favoriteList.length} / ${totalCount} 首歌曲`)
              
              if (this.favoriteList.length > 0) {
                console.log('第一首歌的数据:', this.favoriteList[0])
              }
              
              // 同时保存到 localStorage 作为备份
              localStorage.setItem('favorite_songs', JSON.stringify(this.favoriteList))
            }
          }
        }
      } catch (e) {
        console.error('加载收藏列表失败:', e)
        // 如果 API 失败，尝试从 localStorage 读取
        try {
          const favorites = localStorage.getItem('favorite_songs')
          if (favorites) {
            this.favoriteList = JSON.parse(favorites)
          }
        } catch (err) {
          console.error('从本地存储加载失败:', err)
        }
      } finally {
        this.loading = false
      }
    },
    
    // 格式化时长
    formatDuration(milliseconds) {
      if (!milliseconds) return '-'
      const seconds = Math.floor(milliseconds / 1000)
      const mins = Math.floor(seconds / 60)
      const secs = seconds % 60
      return `${mins}:${secs.toString().padStart(2, '0')}`
    },
    
    // 获取歌手名称
    getSingerNames(singerinfo, song) {
      // 调试: 查看第一首歌的完整数据
      if (song && this.favoriteList.indexOf(song) === 0) {
        console.log('🎤 收藏页面 - 第一首歌数据:', song)
        console.log('🎤 收藏页面 - singerinfo:', singerinfo)
      }
      
      // 如果是数组格式 (标准的 singerinfo)
      if (Array.isArray(singerinfo) && singerinfo.length > 0) {
        const names = singerinfo.map(s => {
          // 处理对象格式的歌手信息
          if (typeof s === 'object' && s !== null) {
            return s.name || s.singer_name || s.singername || s.author_name
          }
          // 处理字符串格式
          return String(s)
        }).filter(name => name && name.trim() && name !== '[object Object]')
        
        // 如果过滤后有有效的名字,返回拼接结果
        if (names.length > 0) {
          return names.join('、')
        }
      }
      // 如果是字符串格式
      if (typeof singerinfo === 'string' && singerinfo.trim()) {
        return singerinfo
      }
      return null // 返回 null 让模板使用备选方案
    },
    
    // 提取歌曲名称（去掉"歌手 - "前缀）
    getSongName(fullName) {
      if (!fullName) return '未知歌曲'
      // 如果包含 " - "，取后面的部分作为歌名
      const parts = fullName.split(' - ')
      if (parts.length > 1) {
        return parts.slice(1).join(' - ') // 处理歌名中也可能包含 " - " 的情况
      }
      return fullName
    },
    
    // 播放歌曲
    playSong(song) {
      // 防止重复快速点击
      if (this.isPlayingSong) {
        console.log('[FavoriteView] 正在处理播放请求，忽略重复操作')
        return
      }
      
      this.isPlayingSong = true
      
      try {
        console.log('[FavoriteView] playSong 调用:', song.name)
        console.log('[FavoriteView] 当前 currentSong:', this.currentSong?.name)
        console.log('[FavoriteView] 当前 currentPlayingHash:', this.currentPlayingHash)
        console.log('[FavoriteView] 歌曲 hash:', song.hash)
        console.log('设置 - enqueueFullPlaylist:', this.settings?.playback?.enqueueFullPlaylist)
        
        // 检查是否开启了"自动将全部歌单歌曲加入播放列表"功能
        if (this.settings?.playback?.enqueueFullPlaylist && this.favoriteList.length > 0) {
          console.log('自动加入全部歌曲到播放列表')
          // 找到当前歌曲在列表中的索引
          const songIndex = this.favoriteList.findIndex(s => s.hash === song.hash)
          
          if (songIndex !== -1) {
            // 重新排列歌单,让当前歌曲排在第一位
            const reorderedList = [
              song,
              ...this.favoriteList.slice(0, songIndex),
              ...this.favoriteList.slice(songIndex + 1)
            ]
            this.$emit('play-all', reorderedList)
          } else {
            // 如果找不到,就正常播放全部
            this.$emit('play-all', this.favoriteList)
          }
        } else {
          // 只播放单曲
          this.$emit('play', song)
        }
      } catch (error) {
        console.error('[FavoriteView] playSong 错误:', error)
      } finally {
        // 延迟重置标志，防止快速点击
        setTimeout(() => {
          this.isPlayingSong = false
        }, 500)
      }
    },
    
    // 下一首播放
    playNext(song) {
      console.log('下一首播放:', song)
      this.$emit('play-next', song)
    },
    
    // 显示右键菜单
    showContextMenu(event, song) {
      // 先关闭所有其他菜单
      contextMenuManager.closeActiveMenu()
      
      // 然后关闭自己的旧菜单，防止瞬移
      this.contextMenuVisible = false
      
      // 使用 nextTick 确保旧菜单完全关闭后再打开新菜单
      this.$nextTick(() => {
        this.currentContextSong = song
        this.contextMenuPosition = {
          x: event.clientX,
          y: event.clientY
        }
        this.contextMenuVisible = true
        
        // 注册到全局管理器
        contextMenuManager.registerMenu(() => {
          this.contextMenuVisible = false
        })
      })
    },
    
    // 切换收藏状态
    toggleFavorite(song) {
      const isFavorite = this.favoriteList.some(s => s.hash === song.hash)
      if (isFavorite) {
        this.removeFavorite(song)
      } else {
        this.addFavorite(song)
      }
    },
    
    // 添加收藏
    addFavorite(song) {
      if (!this.favoriteList.some(s => s.hash === song.hash)) {
        this.favoriteList.push(song)
        localStorage.setItem('favorite_songs', JSON.stringify(this.favoriteList))
        console.log('已添加到收藏:', song.name)
      }
    },
    
    // 从播放列表移除
    removeFromPlaylist(song) {
      this.$emit('remove-from-playlist', song)
    },
    
    // 分享歌曲
    shareSong(song) {
      console.log('分享歌曲:', song)
      // TODO: 实现分享功能
      alert('分享功能开发中...')
    },
    
    // 搜索歌曲
    searchSong(song) {
      console.log('搜索歌曲:', song)
      this.$emit('search', song)
    },
    
    // 播放全部
    playAll() {
      if (this.favoriteList.length > 0) {
        console.log('播放全部')
        this.$emit('play-all', this.favoriteList)
      }
    },
    
    // 清空列表
    clearAll() {
      if (confirm('确定要清空所有收藏吗？')) {
        localStorage.removeItem('favorite_songs')
        this.favoriteList = []
      }
    },
    
    // 移除收藏
    removeFavorite(song) {
      const index = this.favoriteList.findIndex(s => s.hash === song.hash)
      if (index > -1) {
        this.favoriteList.splice(index, 1)
        localStorage.setItem('favorite_songs', JSON.stringify(this.favoriteList))
      }
    },
    
    // 添加到歌单
    addToPlaylist(song) {
      console.log('添加到歌单:', song)
      // TODO: 实现添加到歌单功能
    },
    
    // 下载歌曲
    downloadSong(song) {
      console.log('下载歌曲:', song)
      // TODO: 实现下载功能
    },
    
    // 去发现页面
    goToDiscover() {
      this.$emit('navigate', 'home')
    },

    // 进入歌手页面
    goArtist(song) {
      const id = this.getPrimaryArtistId(song)
      const name = this.getPrimaryArtistName(song)
      this.$emit('navigate', 'artist', { id, name })
    },
    // 进入专辑页面
    goAlbum(song) {
      const id =
        song.album_id ||
        song.albumid ||
        song.AlbumID ||
        song.base?.album_id ||
        song.album_info?.album_id ||
        song.album_info?.id ||
        null
      const name = song.albuminfo?.name || song.album_name || song.remark || song.album_info?.album_name || null
      if (id || name) this.$emit('navigate', 'album', { id, name })
    },

    // 提取首个歌手ID
    getPrimaryArtistId(song) {
      const s = song || {}
      if (s.SingerId || s.singerid || s.AuthorId || s.author_id) return s.SingerId || s.singerid || s.AuthorId || s.author_id
      if (Array.isArray(s.singerinfo) && s.singerinfo.length) {
        const first = s.singerinfo[0]
        return first?.id || first?.singerid || first?.author_id || null
      }
      return null
    },

    // 提取首个歌手名
    getPrimaryArtistName(song) {
      const s = song || {}
      if (s.SingerName || s.singername || s.author_name) return s.SingerName || s.singername || s.author_name
      if (Array.isArray(s.singerinfo) && s.singerinfo.length) {
        const first = s.singerinfo[0]
        return first?.name || first?.singer_name || first?.singername || first?.author_name || null
      }
      // 从 "歌手 - 歌名" 中分离
      if (typeof s.name === 'string' && s.name.includes(' - ')) {
        return s.name.split(' - ')[0]
      }
      return null
    },
    
    // 切换排序顺序
    toggleSortOrder() {
      if (this.sortOrder === 'none') {
        this.sortOrder = 'asc'
      } else if (this.sortOrder === 'asc') {
        this.sortOrder = 'desc'
      } else {
        this.sortOrder = 'none'
      }
    }
  }
}
</script>

<style scoped>
.favorite-view {
  padding: var(--spacing-xl);
  max-width: 1400px;
  margin: 0 auto;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}

.page-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--spacing-xl);
}

.page-title {
  font-size: var(--font-size-2xl);
  font-weight: 600;
  color: var(--color-text);
}

.header-actions {
  display: flex;
  gap: var(--spacing-md);
}

.action-btn {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-sm) var(--spacing-md);
  background: var(--color-background-light);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  color: var(--color-text);
  font-size: var(--font-size-sm);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.action-btn:hover {
  border-color: var(--color-primary);
  color: var(--color-primary);
}

.primary-btn {
  padding: var(--spacing-md) var(--spacing-xl);
  background: var(--color-primary);
  border: none;
  border-radius: var(--radius-md);
  color: white;
  font-size: var(--font-size-base);
  cursor: pointer;
  transition: all var(--transition-fast);
  margin-top: var(--spacing-lg);
}

.primary-btn:hover {
  background: var(--color-primary-hover);
}

/* 加载状态 */
.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-xl) 0;
  color: var(--color-text-secondary);
}

.loading-gif {
  width: 60px;
  height: 60px;
  margin-bottom: var(--spacing-md);
}

/* 空状态 */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-xl) 0;
  text-align: center;
}

.empty-text {
  font-size: var(--font-size-lg);
  color: var(--color-text-secondary);
  margin: var(--spacing-md) 0 var(--spacing-sm);
}

.empty-hint {
  font-size: var(--font-size-sm);
  color: var(--color-text-tertiary);
}

/* 歌曲列表 */
.song-list {
  background: var(--color-background-light);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.list-header,
.song-item {
  display: grid;
  grid-template-columns: 60px 1fr 200px 200px 120px;
  gap: var(--spacing-md);
  align-items: center;
  padding: var(--spacing-md) var(--spacing-lg);
}

.list-header {
  font-size: var(--font-size-sm);
  color: var(--color-text-tertiary);
  border-bottom: 1px solid var(--color-border);
  font-weight: 500;
}

.song-item {
  border-bottom: 1px solid var(--color-border);
  transition: background var(--transition-fast);
  cursor: pointer;
}

.song-item:last-child {
  border-bottom: none;
}

.song-item:hover {
  background: var(--color-background);
}

.song-item.playing {
  background: var(--bg-focus);
}

.song-item.playing .song-name {
  color: var(--color-primary);
}

/* 列样式 */
.col-index {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  justify-content: center;
  cursor: pointer;
  user-select: none;
}

.list-header .col-index:hover {
  color: var(--color-text);
}

.sort-arrow {
  font-size: 12px;
  color: var(--color-primary);
  transition: color var(--transition-fast);
  flex-shrink: 0;
}

.index-number {
  color: var(--color-text-tertiary);
  font-size: var(--font-size-sm);
}

.play-btn {
  display: none;
}

.col-title {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  min-width: 0;
}

.song-cover {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-sm);
  object-fit: cover;
  flex-shrink: 0;
}

.song-info {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  min-width: 0;
  flex: 1;
}

.song-name {
  color: var(--color-text);
  font-size: var(--font-size-sm);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.quality-badge {
  padding: 1px 4px;
  background: var(--bg-focus-medium);
  color: var(--color-primary);
  font-size: 10px;
  border-radius: 2px;
  font-weight: 500;
  flex-shrink: 0;
  border: 1px solid var(--color-primary);
}

.col-artist,
.col-album {
  color: var(--color-text-secondary);
  font-size: var(--font-size-sm);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.artist-link { cursor: pointer; }
.artist-link:hover { color: var(--color-primary); text-decoration: underline; }
.album-link { cursor: pointer; }
.album-link:hover { color: var(--color-primary); text-decoration: underline; }

.col-duration {
  color: var(--color-text-tertiary);
  font-size: var(--font-size-sm);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.action-buttons {
  display: flex;
  gap: var(--spacing-sm);
  opacity: 1;
}

.col-actions {
  display: flex;
  gap: var(--spacing-sm);
  opacity: 0;
  transition: opacity var(--transition-fast);
}

.song-item:hover .col-actions {
  opacity: 1;
}

.icon-btn {
  width: 32px;
  height: 32px;
  border: none;
  background: transparent;
  color: var(--color-text-secondary);
  cursor: pointer;
  transition: all var(--transition-fast);
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
}

.icon-btn:hover {
  background: var(--color-background);
  color: var(--color-text);
}

.icon-btn.danger:hover {
  color: var(--color-error);
}

.play-btn-inline {
  color: var(--color-text);
}

.play-btn-inline:hover {
  color: var(--color-primary);
  transform: scale(1.1);
}

.favorite-btn.active {
  color: var(--color-error);
}

.favorite-btn.active:hover {
  color: var(--color-error-hover);
}
</style>
